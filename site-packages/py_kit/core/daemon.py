
from flask import Flask, render_template, request
from cve_ease.conf import gconfig
from cve_ease.utils import find_cve_from_str, generate_cve_desc, push_to_feishu, parse_cpe32_uri, get_harzard_level, get_cwe_title, get_format_timestamp
from deep_translator import GoogleTranslator
from cve_ease.sql import database
import os
from cve_ease.notifier import FeishuSheet
from cve_ease.models import RESULT, NVD, SRPM, TEST, CVRF, CNNVD

app = Flask(__name__, template_folder=f"{gconfig['main']['result_path']}html")

@app.route('/')
def hello_world():
    return 'Hello, World!'

@app.route('/cve/<cve_id>')
def cve_detail(cve_id):
    return render_template(f"{cve_id}.html")


@app.route('/cve/form')
def form():
    return render_template(f"submit.html")

@app.route('/cve/submit', methods=['POST'])
def submit():
    cve_id = request.form.get('cveid')
    cve_id = find_cve_from_str(cve_id)
    if cve_id == "False":
        return f'param error, {cve_id} is not a correct cve id'
    affectedComponent = request.form.get('affectedcomponent')
    user_name = request.form.get('username')
    if generate_cve_desc(cve_id, affectedComponent, user_name) == False:
        return f'param error, {affectedComponent} is not a correct component name' 
    # push_to_feishu(cve_id)
    return f'cve_id: {cve_id} added successfully!!!'

def run_server():
    app.run(host='0.0.0.0', debug=False)
